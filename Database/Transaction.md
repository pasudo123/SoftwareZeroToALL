## Transaction
한국 말로 __트랜잭션__ 이라고 한다.
* 데이터베이스 관리시스팀(DBMS) 에서 데이터베이스를 다루는 하나의 논리적인 작업의 단위이다.
* 트랜잭션은 분할할 수가 없다.


### 데이터베이스에서 트랜잭션을 정의하는 이유
1. 데이터베이스에서 데이터를 다루는 작업이 일어날 때 장애가 일어나는 경우가 있기 때문에, 이 장애에 대해 올바르게 데이터를 복수하는 작업의 단위를 트랜잭션으로 삼는다.
2. 데이터베이스에서 프로그램이 동시에 실행될 때 프로그램들을 서로 분리하는 단위가 된다.


### 트랜잭션의 예
토마토, 고구마, 복숭아 각각은 "CUSTOMER_NAME" 이다. 예시는 은해의 계좌이체 프로그램의 예시이다.
```SQL
BEGIN TRANSACTION

(1) 토마토 손님의 금액을 조회한다. (SELECT)
SELECT Balance FROM Account WHERE CUSTOMER_NAME = "토마토";

(2) 고구마 손님의 금액을 조회한다. (SELECT)
SELECT Balance FROM Account WHERE CUSTOMER_NAME = "고구마";

(3) 복숭아 손님이 예금을 일만원 인출한다. (UPDATE)
UPDATE Account SET Balance - 10000 WHERE CUSTOMER_NAME = "복숭아";

(4) 고구마 손님이 예금을 일만원 입금한다. (UPDATE)
UPDATE Account SET Balance + 10000 WHERE CUSTOMER_NAME = "고구마";

COMMIT

END TRANSACTION 
```


### 트랜잭션의 성질 (ACID)
트랜잭션이 진행되기 전 / 완료된 후 상태를 볼 수 있지만, 트랜잭션이 진행되는 중간에 데이터를 확인하지 못한다.

__1. 원자성 (Atomicity)__   
분리할 수 없는 하나의 단위로 작업은 __모두 완료 or 모두 취소__ 되어야 한다.   
> 은행의 이체 과정중에서 트랜잭션이 실패하게 되어 예금이 사라지는 경우가 발생한다면, 그 결과의 후폭풍을 거셀것이다. 따라서 DBMS 는 완료되지 않은 트랜잭션의 중간상태를 데이터베이스에 반영하여서는 안된다. 즉 트랜잭션의 모든 연산들이 정상적으로 수행완료가 되거나 혹은 어떠한 연산도 수행되지 않은 상태를 보장하여야 한다. 

__2. 일관성 (Consistency)__   
사용되는 모든 데이터는 일관되어야 한다.   
> 고립된 트랜잭션의 수행이 데이터베이스의 일관성을 보장해야 한다. 즉 성공적으로 수행된 트랜잭션은 정당한 데이터들만을 데이터베이스에 반영해야 한다. 트랜잭션 수행이 보존해야할 일관성은 기본 키, 외래 키 제약과 같은 무결성 제약조건들 뿐만 아니라 도메인의 유효범위, 예금입출금 과정에서 생기는 입출금 전후의 상태가 같아야 한다는 사항 들의 비명시적인 일관성 조건들도 존재한다. 

__3. 격리성 (Isolation)__   
트랜잭션 수행 시 다른 트랜잭션의 연산작업이 들어오지 못하게 보장받아야 한다.   
> 여러 트랜잭션이 동시에 수행되더라도 각각의 트랜잭션은 다른 트랜잭션에 의해서 영향을 받지 않아야 하며, 독립적으로 수행되어야 한다. 격리성을 보장받을 수 있는 가장 쉬운 방법은 모든 트랜잭션이 순차적으로 수행되는 것이다. 하지만 병렬적 수행의 장점을 얻기 위해서 DBMS 는 병렬적으로 수행하면서도 일렬수행과 같은 결과를 보장할 수 있는 방식을 제공하고 있다.

__4. 영속성 (Durability)__   
트랜잭션이 정상적으로 종료되면, 그 결과는 시스템에 영구적으로 적용되어야 한다.
> 트랜잭션이 성공적으로 완료되어 COMMIT 되고 나면, 해당 트랜잭션에 의한 모든 변경은 향후에 어떤 소프트웨어나 하드웨어 장애가 발생하더라도 영구적으로 보존되어야 한다. 


### 트랜잭션 명령어
__1. ROLLBACK__   
롤백은 트랜잭션을 취소하고 난 뒤, 처음부터 시작하거나 혹은 SAVEPOINT 부터 현재까지의 트랜잭션을 취소하고 SAVEPOINT 를 지정한 구간까지 상태를 되돌릴 때 사용한다.

__2. SAVEPOINT__   
세이브포인트는 하나의 트랜잭션 안에 세이브포인트를 주어 구역을 나눌 수 있다.

__3. COMMIT__   
트랜잭션의 끝과 새로운 시작을 나타낸다. COMMIT 을 기준으로 이전의 트랜잭션은 모두 정상적으로 처리되고 이후에 새로운 트랜잭션을 시작하겠다는 의미이다.


### 트랜잭션 수행 시 문제점들
(1) 트랜잭션 1개, 테이블 1개   
* 트랜잭션이 중간에 멈추었을 때 데이터가 문제가 있을 수 있으면 처음상태로 돌아간다.
* 트랜잭션이 중간에 문제점이 있어서 스스로 멈춰야 할 경우가 있다. (ROLLBACK 필요)
* 외부시스템의 문제로 멈춰야 하는 경우가 있다. (RECOVERY 필요)

(2) 트랜잭션 2개, 테이블 2개   
* 트랜잭션이 각각의 테이블을 다룰 경우 문제점이 없다. (외부시스템 문제에서 발생하는 문제는 제외)

(3) 트랜잭션 2개, 테이블 1개   
* 트랜잭션이 동일한 테이블을 다룰 경우 문제점이 있다. (LOCK 필요)
