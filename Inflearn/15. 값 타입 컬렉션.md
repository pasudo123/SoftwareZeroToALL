# 값 타입 컬렉션
- 값 타입을 하나 이상 저장할 때 사용 (값 타입을 컬렉션으로 쓰는 것)
- @ElementCollection 과 @CollectionTable 을 사용
- 데이터베이스 컬렉션을 같은 테이블에 저장할 수 없다.
- 컬렉션을 저장하기 위한 별도의 테이블이 필요하다.

![](https://github.com/pasudo123/SoftwareZeroToALL/blob/master/Image/value-type-collection.png)
- 멤버 테이블에서 값 타입을 두 개 가지고 있다.
- 여기서 값 타입이 컬렉션으로 들어가 있다.

### Member Table
```java
@Entity
public class Member {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "member_id")
    private Long id;

    @Column(name = "username")
    private String username;

    @Embedded
    private Address address;

    @ElementCollection
    @CollectionTable(
            name = "favorite_food",
            joinColumns = {@JoinColumn(name = "member_id")}
    )
    @Column(name = "food_name")
    private Set<String> favoriteFoods = new HashSet<>();

    @ElementCollection
    @CollectionTable(
            name = "address",
            joinColumns = {@JoinColumn(name = "member_id")}
    )
    private List<Address> addressHistory = new ArrayList<>();
}
```

### Address Table
```java
@Embeddable
@Getter
public class Address {

    private String city;
    private String street;
    private String zipcode;

}
```

### 생성되는 테이블 내용.
```java
Hibernate: 
    
    create table Member (
       member_id bigint generated by default as identity,
        city varchar(255),
        street varchar(255),
        zipcode varchar(255),
        username varchar(255),
        primary key (member_id)
    )
    
Hibernate: 
    
    create table address (
       member_id bigint not null,
        city varchar(255),
        street varchar(255),
        zipcode varchar(255)
    )
       
Hibernate: 
    
    create table favorite_food (
       member_id bigint not null,
        food_name varchar(255)
    )
    
Hibernate: 
    
    alter table address 
       add constraint FK6ncq4527mw0seu2b7wr19mqpg 
       foreign key (member_id) 
       references Member
Hibernate: 
    
    alter table favorite_food 
       add constraint FKetdr9m6ysgxkvs2f7vf15sac4 
       foreign key (member_id) 
       references Member
```

### 데이터 삽입하기. (INSERT)
```java
/** 트랜잭션 수행 **/
tx.begin();

try{

    Member member = new Member();

    // 일반 값 타입
    member.setUsername("홍길동");
    member.setAddress(new Address("서울", "남부순환로", "어느 구간의 길"));

    // 값 타입 컬렉션
    member.getFavoriteFoods().add("고구마 피자");
    member.getFavoriteFoods().add("포테이토 피자");
    member.getFavoriteFoods().add("쉬림프 피자");

    // 값 타입 컬렉션
    member.getAddressHistory().add(new Address("통영", "화포면 2길", "화포면 어느 길"));
    member.getAddressHistory().add(new Address("충주", "대학로 20길", "대학가 어느 길"));

    /**
     * 멤버 테이블을 저장할 때,
     * FavoriteFood Table, Address Table 에 같이 값이 들어간다.
     * 이렇게 들어가는 이유는 두 테이블 모두 값 타입이기 떄문이다.
     *
     * 값 타입 컬렉션은 라이프 사이클은 멤버 테이블의 생명주기에 소속된다.
     */
    entityManager.persist(member);

    tx.commit();
```
#### 값 타입 컬렉션은 영속성 전이와 고아객체 제거 기능을 필수로 가진다고 볼 수 있다.

### 데이터 조회하기. (SELECT)
- 값 타입 리스트는 지연로딩 전략을 따른다. 아래와 같이 작성하고 하이버네이트 SQL 문 출력을 살펴보면 아래와 같이 나타난다.
```java
entityManager.persist(member);
entityManager.flush();
entityManager.clear();

System.out.println("=========================================");

/** 값 타입 컬렉션은 지연로딩 전략을 사용한다. **/
Member foundMember = entityManager.find(Member.class, 1L);

System.out.println("========= 내가 가장 좋아하는 과일 출력하기");
for(String fruit : foundMember.getFavoriteFoods()) {
    System.out.println(String.format("==> %s", fruit));
}

System.out.println();
System.out.println("========= 내가 가지고 있는 주소 출력하기");
for(Address address : foundMember.getAddressHistory()) {
    System.out.println(String.format("==> %s", address.toString()));
}

tx.commit();
```

### 출력되는 SQL 문.
```java
=========================================
Hibernate: 
    select
        member0_.member_id as member_i1_6_0_,
        member0_.city as city2_6_0_,
        member0_.street as street3_6_0_,
        member0_.zipcode as zipcode4_6_0_,
        member0_.username as username5_6_0_ 
    from
        Member member0_ 
    where
        member0_.member_id=?
========= 내가 가장 좋아하는 과일 출력하기
Hibernate: 
    select
        favoritefo0_.member_id as member_i1_4_0_,
        favoritefo0_.food_name as food_nam2_4_0_ 
    from
        favorite_food favoritefo0_ 
    where
        favoritefo0_.member_id=?
==> 고구마 피자
==> 포테이토 피자
==> 쉬림프 피자

========= 내가 가지고 있는 주소 출력하기
Hibernate: 
    select
        addresshis0_.member_id as member_i1_0_0_,
        addresshis0_.city as city2_0_0_,
        addresshis0_.street as street3_0_0_,
        addresshis0_.zipcode as zipcode4_0_0_ 
    from
        address addresshis0_ 
    where
        addresshis0_.member_id=?
==> Address(city=통영, street=화포면 2길, zipcode=화포면 어느 길)
==> Address(city=충주, street=대학로 20길, zipcode=대학가 어느 길)
```
